<!DOCTYPE html> <html lang="en"> <head><!-- Primary Meta Tags --><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta name="title" content="Write in neovim anywhere and everywhere"><meta name="description" content="A script that effectively lets you write in any text box using neovim."><meta name="robots" content="all"><!-- browser tab title --><title>tjex • Write in neovim anywhere and everywhere</title><!-- RSS --><link rel="alternate" type="application/rss+xml" title="Tillman Jex : tjex.net" href="https://tjex.net/rss.xml"><!-- Canonical --><link rel="canonical" href="https://tjex.net/hacks/write-in-neovim-everywhere/"><!-- Favicons --><link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="48x48" href="/favicon/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://tjex.net/hacks/write-in-neovim-everywhere/"><meta property="og:title" content="Write in neovim anywhere and everywhere"><meta property="og:description" content="A script that effectively lets you write in any text box using neovim."><meta property="og:image" content="https://tjex.net/img/profile-square.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://tjex.net/hacks/write-in-neovim-everywhere/"><meta property="twitter:title" content="Write in neovim anywhere and everywhere"><meta property="twitter:description" content="A script that effectively lets you write in any text box using neovim."><meta property="twitter:image" content="https://tjex.net/img/profile-square.jpg"> <script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Write in neovim anywhere and everywhere","url":"https://tjex.net/blog/write-in-neovim-everywhere","datePublished":"Mon Aug 05 2024 22:27:49 GMT+0200 (Central European Summer Time)","description":"A script that effectively lets you write in any text box using neovim.","author":{"@type":"Person","name":"tjex","image":{"@type":"ImageObject","url":"https://tjex.net/img/profile-square.jpg","width":488,"height":488},"url":"https://tjex.net","sameAs":["https://tjex.net/blog","undefined","undefined"]},"mainEntityOfPage":{"@type":"WebPage","@id":"https://tjex.net/blog/"}}</script> <link rel="stylesheet" href="/_astro/_page_.WUPP2ssZ.css">
<style>#themeToggle[data-astro-cid-lfoluaxz]{width:70px;height:70px;flex:0 0 auto}
</style><script type="module" src="/_astro/hoisted.Dn1LBlWI.js"></script></head> <div class="wrapper"> <div class="header-wrapper"> <div class="header-left"> <a class="nav-link site-heading" href="/">tjex</a> </div><div class="header-right"> <button class="no-outline" id="themeToggle" aria-label="theme toggle" data-astro-cid-lfoluaxz> <svg id="icon-toggle" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 120 120" width="40" height="40" xml:space="preserve" data-astro-cid-lfoluaxz> <g data-astro-cid-lfoluaxz> <path d="M60,16.005c0,0,0.001,19.736,0.001,43.994c0,24.258-0.001,43.995-0.001,43.995c-24.258,0-43.994-19.736-43.994-43.995
            C16.006,35.742,35.742,16.005,60,16.005 M60,5.005C29.627,5.005,5.006,29.626,5.006,60c0,30.372,24.622,54.995,54.994,54.995
            S114.995,90.371,114.995,60C114.995,29.626,90.372,5.005,60,5.005L60,5.005z" data-astro-cid-lfoluaxz></path> </g> </svg> </button>  <!--
is:inline includes the script directly into the page, instead 
of budling it separately (Astro specific). This decreases load 
time, which is important here to avoid theme flashing
--> <script>
  const themeToggle = document.getElementById("themeToggle");
  const getTheme = () => localStorage.getItem("theme") || "dark";
  const setTheme = (theme) => {
    localStorage.setItem("theme", theme);
    document.documentElement.dataset.theme = theme;
    document.body.classList.add(theme);
  };

  // add the current theme from local storage to DOM, which 
  // happens BEFORE rendering.
  setTheme(getTheme())  

  themeToggle.addEventListener("click", () => {
    if (getTheme() == "light") {
      setTheme("dark");
    } else {
      setTheme("light");
    }
  });
</script> </div> <div class="header-center"></div>  </div> <aside class="aside sidebar-left"> <nav class="nav-left"> <ul> <li><a class="nav-link" href="/blog">blog</a></li> <li><a class="nav-link" href="/hacks">hacks</a></li> <li><a class="nav-link" href="/projects">projects</a></li> <li><a class="nav-link" href="/listening">listening</a></li> <li><a class="nav-link" href="/contact">contact</a></li> </ul> </nav> </aside> <main class="main-content">       <article class="post-content__article"> <h1>Write in neovim anywhere and everywhere</h1> <p class="post-info"> <span>Tillman Jex, <time>August 05, 2024</time></span><br> <span class="secondary">Tagged: </span> <a href="/tags/scripts">scripts</a>
            <span>, </span><a href="/tags/terminal">terminal</a>
            <span></span> <br> <span class="secondary">License: </span> <a href="https://mit-license.org/" target="_blank" rel="noopener noreferrer">
MIT
</a> <br> <!-- if the post has been modified since original publication -->  <br> <!-- for posts that refer to computer programs used -->  </p>  <p>If you write in neovim, you want to write in neovim everywhere.</p>
<p>The below script acts as an intermediary solution, by calling up a neovim
instance, allowing you to write as you know and love, and by executing <code>:wq</code>,
closes the window and pastes the text into the previously focussed text box.</p>
<p>Here is a quick and dirty <a href="https://youtu.be/u_f2e2YfDrc">demo video</a>.</p>
<p>It uses <code>skhd</code> to launch the script via a global keybind, and <code>yabai</code> to tile
the window nicely in place. Additionally, <code>jq</code> is used to halt script execution
until we are done editing our text.</p>
<p>I took a lot of cues from
<a href="https://github.com/cknadler/vim-anywhere">vim-anywere</a>. But vim-anywhere
required <code>macvim</code>, which I didn’t want to have to install and setup.</p>
<p>My solution uses your neovim config as it is (as we’re really just launching
a terminal window, and running neovim inside).</p>
<p>This is mac specific as it is. But the only parts that need to be change for
Linux is the copy program (look for <code>pbcopy</code>) and the <code>osascript</code> (which is only
used for getting the current app before execution, and refocussing on that
program after the kitty process finishes).</p>
<h2 id="requirements">Requirements</h2>
<ul>
<li><a href="https://github.com/koekeishiya/skhd">skhd</a> (to set a global hotkey)</li>
<li><a href="https://github.com/koekeishiya/yabai">yabai</a> (optional, for window
management)</li>
<li><a href="https://github.com/jqlang/jq">jq</a> (for extracting the kitty pid)</li>
<li>vim / neovim / editor of choice</li>
</ul>
<h2 id="breaking-it-up">Breaking it up</h2>
<p>Below reads as: code -> explanation.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6A737D">#!/usr/bin/env bash</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># invoked via global hotkey (skhd).</span></span>
<span class="line"><span style="color:#6A737D"># refreshes a temp file, opens in neovim, copys to clipboard on quit.</span></span>
<span class="line"><span style="color:#6A737D"># heavily inspired by vim-anywhere (https://github.com/cknadler/vim-anywhere)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">kitty</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">which</span><span style="color:#9ECBFF"> kitty</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">nvim</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">which</span><span style="color:#9ECBFF"> neovim</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">pbcopy</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">which</span><span style="color:#9ECBFF"> pbcopy</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">current_app</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">osascript</span><span style="color:#E1E4E8"> $HOME</span><span style="color:#9ECBFF">/.scripts/apple/current-app.scpt</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">compose_file</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">/tmp/vimit.md</span></span>
<span class="line"><span style="color:#E1E4E8">pid_file</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">/tmp/vimit-pid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">kitty_cmd</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"kitty @ set-window-title 'vimit' </span><span style="color:#79B8FF">\</span></span>
<span class="line"><span style="color:#9ECBFF">    &#x26;&#x26; kitten @ ls | jq '.[].tabs[].windows[] | select(.title == </span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">vimit</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">) | .pid' > </span><span style="color:#E1E4E8">$pid_file</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#9ECBFF">    &#x26;&#x26; nvim </span><span style="color:#E1E4E8">$compose_file</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#6A737D"># ...</span></span>
<span class="line"></span>
<span class="line"></span></code></pre>
<p>The <code>osascript</code> grabs the currently focussed app.
<a href="https://github.com/cknadler/vim-anywhere/blob/2c9da7181b6f199afb6ab52e841d5461c113b5cd/script/current_app.scpt">Here is the script</a>.</p>
<p>The <code>kitty_cmd</code> is executed by a kitty terminal process that we launch, it:</p>
<ul>
<li>sets a window title (so that we can filter it easily using <code>jq</code>),</li>
<li>extracts the <code>pid</code> and writes it to <code>$pid_file</code></li>
<li>launches neovim by opening a temp file <code>$compose_file</code></li>
</ul>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6A737D"># ...</span></span>
<span class="line"><span style="color:#6A737D"># cleanup on new execution in case old text needs to be retrieved.</span></span>
<span class="line"><span style="color:#B392F0">rm</span><span style="color:#E1E4E8"> $compose_file</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># execute kitty command</span></span>
<span class="line"><span style="color:#E1E4E8">$kitty -1 -T scratch --session - zsh -l -c </span><span style="color:#9ECBFF">"${</span><span style="color:#E1E4E8">kitty_cmd</span><span style="color:#9ECBFF">}"</span></span>
<span class="line"><span style="color:#6A737D">#...</span></span>
<span class="line"></span>
<span class="line"></span></code></pre>
<p>Delete the old compose file at the start of the script, in case we need to
reference it between invocations of the script (this would not be possible if we
deleted it at the end of the script).</p>
<p>Launch the kitty process. <code>-T scratch</code> gives the kitty window a title
(“scratch”) that <code>yabai</code> can read (it doesn’t read the “vimit” title that we set
in the <code>kitty_cmd</code>. I’m not totally sure why). This allows us to target the
launched window with a <code>yabai</code> rule.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6A737D"># ...</span></span>
<span class="line"><span style="color:#6A737D"># allow time for pid file to be created and</span></span>
<span class="line"><span style="color:#6A737D"># wait for kitty process to finish</span></span>
<span class="line"><span style="color:#B392F0">sleep</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#E1E4E8">vimit_pid</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">cat</span><span style="color:#E1E4E8"> $pid_file)</span></span>
<span class="line"><span style="color:#B392F0">lsof</span><span style="color:#79B8FF"> -p</span><span style="color:#E1E4E8"> $vimit_pid </span><span style="color:#9ECBFF">+r</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8"> &#x26;</span><span style="color:#F97583">></span><span style="color:#E1E4E8">/dev/null</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># only copy and paste if we actually wrote something</span></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#F97583">-e</span><span style="color:#E1E4E8"> $compose_file ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">    $(which</span><span style="color:#9ECBFF"> pbcopy</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8">$compose_file</span></span>
<span class="line"><span style="color:#B392F0">    osascript</span><span style="color:#79B8FF"> -e</span><span style="color:#9ECBFF"> "activate application </span><span style="color:#79B8FF">\"</span><span style="color:#E1E4E8">$current_app</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#B392F0">    skhd</span><span style="color:#79B8FF"> -k</span><span style="color:#9ECBFF"> "cmd - v"</span><span style="color:#6A737D"> # get skhd to simulate `cmd + v`. faster than osascript</span></span>
<span class="line"><span style="color:#B392F0">    rm</span><span style="color:#E1E4E8"> $kitty_ls_file</span></span>
<span class="line"><span style="color:#F97583">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">rm</span><span style="color:#E1E4E8"> $pid_file</span></span>
<span class="line"></span>
<span class="line"></span></code></pre>
<p>Extract the <code>pid</code> from the file we wrote to and wait for the process to finish
with <code>lsof</code>. This will halt execution of the script while the kitty process is
running, meaning that we only copy text from the temporary file after it’s been
written to (after we execute <code>:wq</code>, which subsequently closes the kitty window
and kills the kitty process).</p>
<h2 id="yabai-and-skhd">Yabai and Skhd</h2>
<p>The <code>yabai</code> <a href="https://github.com/koekeishiya/yabai/blob/master/doc/yabai.asciidoc#rule">rule</a> then looks like this:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6A737D"># place the window bottom center.</span></span>
<span class="line"><span style="color:#B392F0">yabai</span><span style="color:#79B8FF"> -m</span><span style="color:#9ECBFF"> rule</span><span style="color:#79B8FF"> --add</span><span style="color:#9ECBFF"> app="(^WezTerm$|^kitty$)"</span><span style="color:#9ECBFF"> title="^scratch$"</span><span style="color:#9ECBFF"> opacity=</span><span style="color:#79B8FF">1.0</span><span style="color:#9ECBFF"> sticky=on</span><span style="color:#9ECBFF"> manage=off</span><span style="color:#9ECBFF"> grid=3:3:1:2:1:1</span></span>
<span class="line"></span>
<span class="line"></span></code></pre>
<p>And for <code>skhd</code>:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">alt</span><span style="color:#9ECBFF"> +</span><span style="color:#9ECBFF"> cmd</span><span style="color:#9ECBFF"> -</span><span style="color:#9ECBFF"> i</span><span style="color:#9ECBFF"> :</span><span style="color:#9ECBFF"> ~/.scripts/utility/vimit.sh</span></span>
<span class="line"></span>
<span class="line"></span></code></pre>
<h2 id="full-script">Full Script</h2>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6A737D">#!/usr/bin/env bash</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># invoked via global hotkey (skhd).</span></span>
<span class="line"><span style="color:#6A737D"># refreshes a temp file, opens in neovim, copys to clipboard on quit.</span></span>
<span class="line"><span style="color:#6A737D"># heavily inspired by vim-anywhere (https://github.com/cknadler/vim-anywhere)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">kitty</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">which</span><span style="color:#9ECBFF"> kitty</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">nvim</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">which</span><span style="color:#9ECBFF"> neovim</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">pbcopy</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#79B8FF">which</span><span style="color:#9ECBFF"> pbcopy</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">current_app</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">osascript</span><span style="color:#E1E4E8"> $HOME</span><span style="color:#9ECBFF">/.scripts/apple/current-app.scpt</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">compose_file</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">/tmp/vimit.md</span></span>
<span class="line"><span style="color:#E1E4E8">pid_file</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">/tmp/vimit-pid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">kitty_cmd</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"kitty @ set-window-title 'vimit' </span><span style="color:#79B8FF">\</span></span>
<span class="line"><span style="color:#9ECBFF">    &#x26;&#x26; kitten @ ls | jq '.[].tabs[].windows[] | select(.title == </span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">vimit</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">) | .pid' > </span><span style="color:#E1E4E8">$pid_file</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#9ECBFF">    &#x26;&#x26; nvim </span><span style="color:#E1E4E8">$compose_file</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># cleanup on new execution incase old text needs to be retrieved.</span></span>
<span class="line"><span style="color:#B392F0">rm</span><span style="color:#E1E4E8"> $compose_file</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># execute kitty command</span></span>
<span class="line"><span style="color:#E1E4E8">$kitty -1 -T scratch --session - zsh -l -c </span><span style="color:#9ECBFF">"${</span><span style="color:#E1E4E8">kitty_cmd</span><span style="color:#9ECBFF">}"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># allow time for pid file to be created and</span></span>
<span class="line"><span style="color:#6A737D"># wait for kitty process to finish</span></span>
<span class="line"><span style="color:#B392F0">sleep</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#E1E4E8">vimit_pid</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">$(</span><span style="color:#B392F0">cat</span><span style="color:#E1E4E8"> $pid_file)</span></span>
<span class="line"><span style="color:#B392F0">lsof</span><span style="color:#79B8FF"> -p</span><span style="color:#E1E4E8"> $vimit_pid </span><span style="color:#9ECBFF">+r</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8"> &#x26;</span><span style="color:#F97583">></span><span style="color:#E1E4E8">/dev/null</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># only copy and paste if we actually wrote something</span></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> [[ </span><span style="color:#F97583">-e</span><span style="color:#E1E4E8"> $compose_file ]]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#B392F0">    $(which</span><span style="color:#9ECBFF"> pbcopy</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8">$compose_file</span></span>
<span class="line"><span style="color:#B392F0">    osascript</span><span style="color:#79B8FF"> -e</span><span style="color:#9ECBFF"> "activate application </span><span style="color:#79B8FF">\"</span><span style="color:#E1E4E8">$current_app</span><span style="color:#79B8FF">\"</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#B392F0">    skhd</span><span style="color:#79B8FF"> -k</span><span style="color:#9ECBFF"> "cmd - v"</span><span style="color:#6A737D"> # faster than osascript</span></span>
<span class="line"><span style="color:#B392F0">    rm</span><span style="color:#E1E4E8"> $kitty_ls_file</span></span>
<span class="line"><span style="color:#F97583">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">rm</span><span style="color:#E1E4E8"> $pid_file</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span></code></pre> <hr> <div class="neighbourPost"> <a class="prevPost" href="/hacks/wezterm-switch-to-previous-workspace"> Switch to previous workspace in WezTerm </a> <a class="nextPost" href="/hacks/ignore-specific-commands-from-zsh-history"> Ignore specific commands from being written to zsh history </a> </div>  </article>    </main> <aside class="aside sidebar-right"></aside> <div class="footer">
Built with <a href="https://astro.build">Astro</a> and <a href="https://picocss.com">Pico CSS</a> •
<a href="/privacy">Privacy</a> • <a href="/rss.xml" rel="me">RSS</a> </div> </div> </html>